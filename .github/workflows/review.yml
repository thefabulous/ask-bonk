name: Review

on:
  pull_request_review_comment:
    types: [created]

jobs:
  review:
    if: github.event.sender.type != 'Bot'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Get PR number
        id: pr-number
        run: |
          echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT

      - name: Verify PR exists
        id: verify-pr
        run: |
          if gh api /repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }} > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::PR #${{ github.event.pull_request.number }} not found, skipping review"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout repository
        if: steps.verify-pr.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Bun
        if: steps.verify-pr.outputs.exists == 'true'
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        if: steps.verify-pr.outputs.exists == 'true'
        run: bun install --frozen-lockfile

      - name: Get PR details
        if: steps.verify-pr.outputs.exists == 'true'
        id: pr-details
        run: |
          gh api /repos/${{ github.repository }}/pulls/${{ steps.pr-number.outputs.number }} > /tmp/pr_data.json
          echo "title=$(jq -r .title /tmp/pr_data.json)" >> $GITHUB_OUTPUT
          echo "sha=$(jq -r .head.sha /tmp/pr_data.json)" >> $GITHUB_OUTPUT
          {
            echo 'body<<EOF'
            jq -r .body /tmp/pr_data.json
            echo EOF
          } >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Bonk
        if: steps.verify-pr.outputs.exists == 'true'
        uses: ask-bonk/ask-bonk/github@main
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
        with:
          model: opencode/claude-opus-4-5
          mentions: '/review'
          permissions: write
          agent: reviewer
          prompt: |
            Review the following pull request (title: ${{ steps.pr-details.outputs.title }}) against the below review guidelines:

            Please check all the code changes in this pull request against the style guide, also look for any bugs if they exist. Diffs are important but make sure you read the entire file to get proper context. Make it clear the suggestions are merely suggestions and the human can decide what to do.

            Refer to AGENTS.md and any additional instructions for our style guide, conventions and repo-wide rules.

            1. Focus on actual violations and bugs. Where possible, comment on the exact line number to help guide the reviewer.
            2. Break up "needs fixing" (real logic bugs, poor error handling, security issues) vs. "suggestions" (nested logic, unused code, code structure/maintenance guidance) when responding so that a human has clear, actionable feedback.
            3. **IMPORTANT**: Use the gh cli to create inline comments on specific code locations. Execute bash commands using the Bash tool to create these comments. Examples:

               For inline comments on specific lines in the diff:
               ```bash
               gh pr review ${{ steps.pr-number.outputs.number }} --comment \
                 --body "**Bug**: This could cause a null pointer exception. Consider adding a null check before accessing \`user.name\`." \
                 --path "src/handlers.ts" \
                 --line 42
               ```

               For suggesting code changes (use this for high-confidence fixes):
               ```bash
               gh pr review ${{ steps.pr-number.outputs.number }} --comment \
                 --body "**Suggestion**: Fix potential null reference" \
                 --path "src/handlers.ts" \
                 --line 42 \
                 --suggestion
               ```

               You MUST create individual inline comments for each issue found. Do not just list issues in your final summary.
            4. Your summary will be posted as a comment for you by OpenCode. Keep it brief and reference the inline comments you created.

            In general, aim to provide actionable inline comments on specific code locations rather than generic summaries.

            <pr_number>
            ${{ steps.pr-number.outputs.number }}
            </pr_number>
            <pr_description>
            ${{ steps.pr-details.outputs.body }}
            </pr_description>

            If the PR looks good, respond with only "LGTM!". No need to pad your response if the PR passes review.
