#!/usr/bin/env bash
set -euo pipefail

# Get the tag that triggered this workflow
current_tag="${GITHUB_REF#refs/tags/}"

if [[ ! "$current_tag" =~ ^github-v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    echo "Not a valid github-v*.*.* tag: $current_tag"
    exit 1
fi

echo "Published tag: $current_tag"

# Build bundled dist files â€” eliminates bun runtime dependency.
# These are gitignored; we commit them here so they exist at the published tag.
echo "Building dist files..."
mkdir -p dist
bun build script/orchestrate.ts --target=node --outfile=dist/orchestrate.js
bun build script/finalize.ts --target=node --outfile=dist/finalize.js

echo "Build complete:"
ls -la dist/

# Force-add dist (gitignored) and commit to the tag ref so consumers
# checking out the action at this tag get the pre-bundled JS files.
git add -f dist/
git commit -m "build: bundle dist for ${current_tag}"
git tag -f "$current_tag"
git push origin "$current_tag" --force
